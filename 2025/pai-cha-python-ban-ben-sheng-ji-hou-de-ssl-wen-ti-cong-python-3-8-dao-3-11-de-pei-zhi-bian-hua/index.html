<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content=#000000 id=color_chrome name=theme-color><meta content=#000000 id=color_safari name=apple-mobile-web-app-status-bar-style><meta content="Jam's Blog" name=description><link rel="Shortcut Icon" href=https://blog.fullstackjam.dev/favicon.svg><link href=https://blog.fullstackjam.dev/favicon.svg rel=Bootmark><link title="Jam's Blog" href=https://blog.fullstackjam.dev/rss.xml rel=alternate type=application/rss+xml><style>#title,body{line-height:1.6em}body{background:#000;color:#00c000;font-size:1.2em}#container{margin:2.4em auto;width:72%}#header{text-align:center}#header>a{font-size:.96em;margin:auto 1em}#title{font-size:1.6em;font-weight:700;margin:1em auto}#date{font-style:italic}#list>li{margin:.8em auto;list-style:disc}img{max-width:100%}a{color:inherit;text-decoration:none}#content a,a:hover{text-decoration:underline}pre{padding:1em;overflow:auto;background:#1b1d16}:not(pre) >code{padding:.2em;background:#1b1d16;overflow:auto}blockquote{padding:0 1em;margin:0;border-left:.25em solid #212121}@media (max-width:600px){#container{width:88%}#header>a{margin:auto .3em}}</style><title>排查 Python 版本升级后的 SSL 问题：从 Python 3.8 到 3.11 的配置变化 - Jam's Blog</title><body><div id=header><a href=https://blog.fullstackjam.dev>Jam's Blog</a><a href=https://blog.fullstackjam.dev/about/>About</a><a href=https://blog.fullstackjam.dev/friends/>Friends</a><a href=https://blog.fullstackjam.dev/projects/>Projects</a></div><div id=container><a href=https://blog.fullstackjam.dev/2025/pai-cha-python-ban-ben-sheng-ji-hou-de-ssl-wen-ti-cong-python-3-8-dao-3-11-de-pei-zhi-bian-hua/ id=title>排查 Python 版本升级后的 SSL 问题：从 Python 3.8 到 3.11 的配置变化</a><div id=date>2025-02-06</div><div id=content><p>在进行 Python 项目的 SSL/TLS 连接配置时，很多开发者可能遇到过类似的问题：在升级 Python 版本后，之前正常工作的代码突然开始出现 SSL 错误。这个问题对于使用 Python 3.8 版本的开发者来说，在升级到 Python 3.11 时尤为常见。在本文中，我将分享我在升级过程中遇到的 SSL 配置问题，并提供解决方案，帮助遇到同样问题的开发者理解问题的根本原因及其解决方法。<h2 id=wen-ti-bei-jing>问题背景</h2><p>在我的项目中，我使用了 <code>ssl.create_default_context()</code> 来配置 SSL 上下文，并在客户端与服务器之间建立安全连接。之前在 Python 3.8 中，这段代码可以正常工作：<pre class=language-python data-lang=python><code class=language-python data-lang=python>context = ssl.create_default_context(ssl.Purpose.CLIENT_AUTH)
context.load_cert_chain(certfile="mycertfile", keyfile="mykeyfile")
</code></pre><p>然而，当我将 Python 版本从 3.8 升级到 3.11 后，代码出现了一个问题，错误信息为：<pre><code>aiohttp.client_exceptions.ClientConnectorCertificateError: certificate verify failed: unable to get local issuer certificate
</code></pre><p>这个错误表明 SSL 证书验证失败，具体是因为无法获取本地的证书颁发机构（CA）证书。最初，我认为可能是证书本身存在问题，但经过进一步排查，我发现问题出在 Python 升级后默认的 SSL 配置发生了变化。<h2 id=tong-guo-pai-cha-zhao-dao-wen-ti-de-gen-ben-yuan-yin>通过排查找到问题的根本原因</h2><h3 id=1-mo-ren-ssl-shang-xia-wen-pei-zhi-de-bian-hua>1. <strong>默认 SSL 上下文配置的变化</strong></h3><p>在 Python 3.8 中，<code>ssl.create_default_context()</code> 默认启用了 <code>PROTOCOL_TLS</code> 协议，且在很多情况下，并没有严格的证书验证，尤其是 <code>check_hostname</code> 和 <code>cert_required</code> 的默认设置是比较宽松的。这意味着即使证书链不完整，或者证书主机名验证失败，程序仍然可以顺利运行。<p>然而，在 Python 3.11 中，<code>ssl.create_default_context()</code> 默认使用 <code>PROTOCOL_TLS_CLIENT</code> 协议，并启用了更严格的证书验证。特别是：<ul><li><code>check_hostname</code> 默认为 <code>True</code>，即要求服务器证书中的主机名与连接的服务器主机名匹配。<li><code>cert_required</code> 默认为 <code>True</code>，即默认会验证服务器证书的有效性，确保证书链完整。</ul><p>因此，Python 3.11 中会在连接时更严格地检查证书，导致如果证书链不完整或证书不受信任，连接将失败，报出 <code>certificate verify failed</code> 错误。<h3 id=2-zheng-shu-yan-zheng-he-zhu-ji-ming-yan-zheng-de-mo-ren-kai-qi>2. <strong>证书验证和主机名验证的默认开启</strong></h3><p>在 Python 3.11 中，<code>SSLContext</code> 对象的默认配置已经发生了变化。具体来说：<ul><li>默认启用了主机名验证（<code>check_hostname = True</code>），如果证书中的主机名和实际主机名不匹配，就会抛出异常。<li>默认启用了证书验证（<code>verify_mode = ssl.CERT_REQUIRED</code>），如果证书无效或缺失根证书，也会导致连接失败。</ul><p>这些默认设置增加了 SSL 连接的安全性，但也可能导致原本在 Python 3.8 中能够正常运行的代码在 Python 3.11 中出现问题。<h2 id=jie-jue-fang-an>解决方案</h2><p>为了让代码在 Python 3.11 中正常工作，并避免过度修改已有的证书配置，我采取了以下解决方法：<h3 id=1-xian-shi-she-zhi-ssl-shang-xia-wen-pei-zhi>1. <strong>显式设置 SSL 上下文配置</strong></h3><p>在 Python 3.11 中，显式设置 <code>SSLContext</code> 的协议版本以及证书验证选项，可以恢复与 Python 3.8 类似的行为。具体代码如下：<pre class=language-python data-lang=python><code class=language-python data-lang=python>import ssl
import aiohttp

# 创建 SSL 上下文，指定客户端协议
context = ssl.SSLContext(ssl.PROTOCOL_TLS_CLIENT)

# 禁用主机名验证
context.check_hostname = False

# 禁用证书验证
context.verify_mode = ssl.CERT_NONE

# 加载证书
context.load_cert_chain(certfile="mycertfile", keyfile="mykeyfile")

# 创建 aiohttp 会话并发起请求
async with aiohttp.ClientSession(connector=aiohttp.TCPConnector(ssl_context=context)) as session:
    async with session.get('https://example.com') as response:
        print(await response.text())
</code></pre><h3 id=2-li-jie-jie-jue-fang-an-de-an-quan-ying-xiang>2. <strong>理解解决方案的安全影响</strong></h3><p>虽然这种做法解决了在 Python 3.11 中由于证书验证问题导致的错误，但它禁用了 SSL/TLS 的证书验证和主机名验证。在生产环境中，禁用证书验证会导致潜在的安全风险，例如容易受到中间人攻击（MITM）。因此，建议在生产环境中：<ul><li>使用有效的证书链和根证书。<li>确保服务器的证书与主机名匹配，避免禁用 <code>check_hostname</code> 和 <code>verify_mode</code>。</ul><h2 id=zong-jie>总结</h2><p>在将 Python 版本从 3.8 升级到 3.11 后，由于默认的 SSL 上下文配置发生了变化，导致原本正常工作的代码无法再通过证书验证。这是因为 Python 3.11 默认启用了更严格的证书验证和主机名验证。通过显式设置 <code>SSLContext</code> 的属性，我们可以恢复 Python 3.8 中的行为，解决了证书验证失败的问题。<p>然而，禁用证书验证和主机名验证虽然解决了问题，但也带来了安全风险。因此，在正式环境中，我们应确保证书链的完整性并启用相关的验证，以保障 SSL/TLS 连接的安全。<p>希望这篇博客能帮助到其他遇到类似问题的开发者，并提供一个参考解决方案。<h3 id=can-kao-wen-dang>参考文档</h3><ul><li><a href=https://docs.python.org/zh-cn/3.11/library/ssl.html>Python 3.11 ssl 模块文档</a></ul></div><div id=comments-issue-id style=display:none>6</div><style>#comment-header,#comment-list>li{margin:1em auto}#comment-avatar,#comment-tip{margin:auto .2em}#comment-action-avatar,#comment-avatar{width:1em;height:1em}#comment-action-info>*,#comment-action-input>*,#comment-info>*{display:inline-block;vertical-align:middle}#comment-header{font-size:1.6em;font-weight:700;line-height:1.6em}#comment-tip{font-style:italic}#comment-list{list-style:none;padding:0}#comment-action-author,#comment-author{font-weight:700;margin:auto .4em}#comment-datetime{font-size:.8em;font-style:italic}#comment-body{margin:auto 1.8em}#comment-action-info>*{margin:1em .2em}#comment-action-input{height:2em;width:100%;margin:1em auto}#comment-action-input>*{height:100%;margin:0 .2em}#comment-action-textarea{width:calc(100% - 8em)}#comment-action-post{width:6em}#comment-action-login{margin:1em .3em}</style><ol id=comment-list></ol><div id=comment-action></div><script>const y=e=>{var t=/\\([\\\|`*_{}\[\]()#+\-~])/g,n=/\n *&gt; *([^]*?)(?=(\n|$){2})/g,i=/\n( *)(?:[*\-+]|((\d+)|([a-z])|[A-Z])[.)]) +([^]*?)(?=(\n|$){2})/g,o=/(^|[^A-Za-z\d\\])(([*_])|(~)|(\^)|(--)|(\+\+)|`)(\2?)([^<]*?)\2\8(?!\2)(?=\W|_|$)/g,a=/^.*\n( *\|( *:?-+:?-+:? *\|)* *\n|)/,c=/.*\n/g,m=/\||(.*?[^\\])\|/g;const l=(t,n)=>{e=e.replace(t,n)},d=(e,t)=>"<"+e+">"+t+"</"+e+">",r=e=>e.replace(n,((e,t)=>d("blockquote",r(u(t.replace(/^ *&gt; */gm,"")))))),s=e=>e.replace(i,((e,t,n,i,o,a)=>(e=d("li",u(a.split(RegExp("\n ?"+t+"(?:(?:\\d+|[a-zA-Z])[.)]|[*\\-+]) +","g")).map(s).join("</li><li>"))),"\n"+(n?'<ol start="'+(i?n+'">':parseInt(n,36)-9+'" style="list-style-type:'+(o?"low":"upp")+'er-alpha">')+e+"</ol>":d("ul",e))))),u=e=>e.replace(o,((e,t,n,i,o,a,c,m,l,r)=>t+d(i?l?"strong":"em":o?l?"s":"sub":a?"sup":c?"small":m?"big":"code",u(r))));var p=[],h=0;return e="\n"+e+"\n",l(/</g,"&lt;"),l(/>/g,"&gt;"),l(/\t|\r|\uf8ff/g,"  "),e=r(e),l(/^([*\-=_] *){3,}$/gm,"<hr/>"),e=s(e),l(/<\/(ol|ul)>\n\n<\1>/g,""),l(/\n((```|~~~).*\n?([^]*?)\n?\2|((    .*?\n)+))/g,((e,t,n,i,o)=>(p[--h]=d("pre",d("code",i||o.replace(/^    /gm,""))),h+""))),l(/((!?)\[(.*?)\]\((.*?)( ".*")?\)|\\([\\`*_{}\[\]()#+\-.!~]))/g,((e,n,i,o,a,c,m)=>(p[--h]=a?i?'<img src="'+a+'" alt="'+o+'"/>':'<a href="'+a+'">'+u(o).replace(t,"$1")+"</a>":m,h+""))),l(/&lt;(.*?)&gt;/g,((e,n)=>'<a href="'+n+'">'+u(n).replace(t,"$1")+"</a>")),l(/\n(( *\|.*?\| *\n)+)/g,((e,n)=>{var i=n.match(a)[1];return"\n"+d("table",n.replace(c,((e,n)=>e==i?"":d("tr",e.replace(m,((e,o,a)=>a?d(i&&!n?"th":"td",u(o||"").replace(t,"$1")):""))))))})),l(/(?=^|>|\n)([>\s]*?)(#{1,6}) (.*?)( #*)? *(?=\n|$)/g,((e,n,i,o)=>n+d("h"+i.length,u(o).replace(t,"$1")))),l(/(?=^|>|\n)\s*\n+([^<]+?)\n+\s*(?=\n|<|$)/g,((e,n)=>d("p",u(n).replace(t,"$1")))),l(/-\d+\uf8ff/g,(e=>p[parseInt(e,10)])),e.trim()},f=e=>{let t=t=>e.next(t),n=t=>e.throw(t);return new Promise(((i,o)=>{let a=e=>{e.done?i(e.value):Promise.resolve(e.value).then(t,n).then(a,o)};a(e.next())}))};let g;const m=document.getElementById("comments-issue-id").innerText,n=new URL(window.location.href);let q,p=n.searchParams.get("github_access_token");p&&(document.cookie=`github_access_token=${p};Path=/;Secure;SameSite=Strict`,n.searchParams.delete("github_access_token"),window.location.replace(n)),null!=p||(p=null==(q=document.cookie.split(";").find((e=>e.trim().startsWith("github_access_token="))))?void 0:q.trim().substring(20));const r=()=>{document.cookie="github_access_token=;expires=Thu, 01 Jan 1970 00:00:00 GMT;Path=/;Secure;SameSite=Strict",p=null},t=()=>f(function*(){var e;let n;if(g=JSON.parse(null!=(n=null==(e=document.getElementById("comments-addition"))?void 0:e.innerText)?n:"[]"),p){if(200!==(e=yield fetch(`https://comments.fullstackjam.dev/comments?issue_id=${m}&github_access_token=${p}`,{method:"GET"})).status)return r(),yield t()}else e=yield fetch(`https://comments.fullstackjam.dev/comments?issue_id=${m}`,{method:"GET"});200===e.status&&(g=g.concat(yield e.json()))}()),u=()=>{g.sort(((e,t)=>new Date(e.created_at).getTime()-new Date(t.created_at).getTime()));let e=document.getElementById("comment-list");e.innerHTML="";var t=document.createElement("div");for(t.id="comment-header",t.innerText="Comments",e.appendChild(t),0===g.length&&((t=document.createElement("div")).id="comment-tip",t.innerText="No comment yet",e.appendChild(t)),t=0;t<g.length;t++){let o=document.createElement("li");var n=document.createElement("div");n.id="comment-info";var i=document.createElement("img");i.id="comment-avatar",i.src=g[t].user.avatar_url,n.appendChild(i),(i=document.createElement("a")).id="comment-author",i.innerText=g[t].user.login,g[t].user.html_url&&(i.href=g[t].user.html_url),n.appendChild(i),(i=document.createElement("div")).id="comment-datetime",i.innerText=new Date(g[t].created_at).toLocaleString(),n.appendChild(i),o.appendChild(n),(n=document.createElement("div")).id="comment-body",n.innerHTML=y(g[t].body),o.appendChild(n),e.appendChild(o)}},v=()=>f(function*(){let e=document.getElementById("comment-action");e.innerHTML="";var n=document.createElement("div");if(n.id="comment-header",n.innerText="Leave a comment",e.appendChild(n),p){if(200===(n=yield fetch(`https://comments.fullstackjam.dev/userinfo?github_access_token=${p}`,{method:"GET"})).status){n=yield n.json();let o=document.createElement("div");o.id="comment-action-info";var i=document.createElement("img");i.id="comment-action-avatar",i.src=n.avatar_url,o.appendChild(i),(i=document.createElement("a")).id="comment-action-author",i.innerText=n.login,i.href=n.html_url,o.appendChild(i);let a=document.createElement("button");a.id="comment-action-logout",a.innerText="Logout",a.addEventListener("click",(()=>{r(),v()})),o.appendChild(a),e.appendChild(o),(n=document.createElement("div")).id="comment-tip",n.innerText="Before posting a comment, consider if it's relevant, sensible, and kind. Would it bother you if someone else wrote it?",e.appendChild(n),(n=document.createElement("div")).id="comment-action-input";let c=document.createElement("textarea");c.id="comment-action-textarea",c.placeholder="Leave a comment",n.appendChild(c);let l=document.createElement("button");return l.id="comment-action-post",l.innerText="Comment",l.addEventListener("click",(()=>f(function*(){a.disabled=!0,c.disabled=!0,l.disabled=!0;let e=c.value.trim();0!==e.length&&(201===(yield fetch(`https://comments.fullstackjam.dev/comments?issue_id=${m}&github_access_token=${p}`,{method:"POST",body:JSON.stringify({body:e})})).status?t().then((()=>u())).then((()=>v())):(r(),yield v(),window.alert("Failed to post comment")))}()))),n.appendChild(l),void e.appendChild(n)}r()}(n=document.createElement("div")).id="comment-tip",n.innerText="Clicking the login button means you agree to use cookies to store your GitHub Access Token",e.appendChild(n),(n=document.createElement("button")).id="comment-action-login",n.innerText="Login with GitHub",n.addEventListener("click",(()=>window.location.replace(`https://comments.fullstackjam.dev/login?redirect_uri=${window.location.href}`))),e.appendChild(n)}());t().then((()=>u())).then((()=>v()))</script></div>